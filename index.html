<!DOCTYPE html>
<html>
<head>
	<title>Socket Test</title>
	<script type="text/javascript" src="./socket.io.js"></script>
	<script type="text/javascript">
    	const NUMBER_REGEX = new RegExp("b\\'([\\d]+)");
		const socket = io();

		socket.on('my response', function(msg) {
        	const el = document.getElementById("recieved");
        	const divElement = document.createElement("div");

        	divElement.innerText = msg.data;
        	el.appendChild(divElement);
    	});

    	const mv_to_f = function (mv) {
    		return (mv - 352.4) / 4.6;
    	};

    	const format_response = function (line_item) {
    		const datum = +NUMBER_REGEX.exec(line_item).pop();
    		const temperature = mv_to_f(datum);

    		return `${Math.round(temperature)}Â°F - ${datum} - ${line_item}`;
    	};

    	socket.on('sensor reading broadcast', function(msg) {
        	const el = document.getElementById("reading-banner");
        	const headingElement = document.createElement("h2");

        	headingElement.innerText = format_response(msg.data);
        	el.replaceChildren(headingElement);
    	});

		window.addEventListener("load", function (event) {
			const emitButton = document.getElementById("emit-button");

	    	emitButton.addEventListener("click", function(event) {
	    		const emitText = document.getElementById("emitter").value;
	    		socket.emit('my event', {data: emitText});
			});

			const broadcastButton = document.getElementById("broadcast-button");

	    	broadcastButton.addEventListener("click", function(event) {
	    		const broadcastText = document.getElementById("broadcaster").value;
	    		socket.emit('my broadcast event', {data: broadcastText});
			});
		});
	</script>
	<style type="text/css">
		textarea {
		    height: 10em;
    		width: 18em;
		}
		.input-wrapper {
		    display: grid;
    		margin: 9px;
    		grid-gap: 8px;
		}
		.input-fields {
			display: flex;
    		flex-flow: wrap;
		}
	</style>
</head>
<body>
	<div class="banner">
		<h1>Flask-SocketIO Test</h1>
	</div>
	<div class="reading-banner" id="reading-banner">
	</div>
	<form>
		<div class="send-area">
			<div class="sub-banner send-sub-banner">
				<h2>Send:</h2>
			</div>
			<div class="input-fields">
				<div class="input-wrapper">
					<textarea name="emitter" id="emitter"></textarea>
					<input type="button" name="emit" id="emit-button" value="Emit" />
				</div>
				<div class="input-wrapper">
					<textarea name="broadcaster" id="broadcaster"></textarea>
					<input type="button" id="broadcast-button" name="broadcast" value="Broadcast" />
				</div>
			</div>
		</div>
		<div class="recieve-area">
			<div class="sub-banner receive-sub-banner">
				<h2>Receive:</h2>
			</div>
			<div id="recieved"></div>
		</div>
	</form>
</body>
</html>